title APP2APP Flow OOB

participant "TPP" as tpp
participant "Mobile" as mobile
participant "App Instituição" as banco
participant "BFF-Instituição" as bff
participant "AS-Instituição" as idp
participant "AS-OOB" as as

entryspacing 0.9
tpp->mobile:URL Inicio OAuth
mobile->banco:URL Inicio OAuth

group start 

banco->bff:GET na URL + Header Accept "application/json"
note over bff:Guardar URL do AS para\ncomparação de URLs absolutas

bff->as:GET na URL + Header Accept "application/json"

end 

loop Processador de eventos

as->as:Processa o request
as-->bff:RESPONSE\n(ver casos abaixo)

alt case REDIRECT TO AS

as-->bff:HTTP STATUS 302 / 303\nREDIRECT para URL do AS (Cookies)\nURLs absolutas e relativas

bff->as:GET URL (Cookies)

else case LOGIN

as-->bff:HTTP STATUS 200\nJSON {step:"login", \n"proceedPath":"<proceedURL>", \n"abortPath": "<abortURL>"} (Cookies)
bff-->banco:Solicita credenciais do usuário
banco->banco:Solicita credenciais ao usuário

alt case Sucesso
banco->bff: Credenciais do usuário
bff->idp:Autentica o usuário\n(OB exige 2 fatores de\n autenticação consentimento\nde pagamento)

idp-->bff:Autenticado
bff->bff:Gera JWT assinado\nclaims: CPF,\nCNPJ,\n Nome Completo

bff->as:POST <proceedURL>\ncom JWT assinado (Cookies)

else case Abort

banco->bff: Usuário aborta operação
bff->as:GET <abortURL>\n(Cookies)

end 

else case CONSENT

bff<--as:JSON {\nstep:"consent", \n"proceedPath": "<proceedURL>",\n"path_abort": "<abortURL>", \n"data": {tppLogoUrl: "<logoURL>", consent:{dadosConsentimento}}}\n(Cookies)
banco<--bff:Solicita confirmação do consentimento
banco->banco:Exibe e confirma consentimento, seleciona produtos

alt case Sucesso

banco->bff:Informa seleção do consentimento
bff->as:POST <proceedURL>\ncom seleção de produtos (Cookies) 

else case Abort

banco->bff: Usuário aborta operação
bff->as:GET <abortURL>\n(Cookies)

end 

else case Erro

as-->bff:JSON {\nstep:"error", \n"errorPath": "<errorURL>",\n"errorType": "<errorType>", \n"errorDescription": "<description>"}\n(Cookies)
banco<--bff:Informar erro ao usuário

banco->banco:Tela de transição\ncom mensagem de erro\npara TPP (exibir logo)

banco->mobile:Abre a <errorURL>
destroyafter banco
mobile->tpp:<URL>

else case Consentimento terminado

as-->bff:HTTP STATUS 302 / 303\nREDIRECT para URL não-AS\nou HEADER X-Target com valor TPP
banco<--bff:REDIRECT <URL>

banco->banco:Tela de transição\npara TPP (exibir logo)

banco->mobile:Abre a <URL>
destroyafter banco
mobile->tpp:<URL>

end 

end