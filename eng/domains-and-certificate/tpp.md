# Central Directory Certificates (SANDBOX)

***

**:warning: ATTENTION**: Never share your private keys on internet services.

***

This guide is a compilation of documents for generating Open Banking certificates.

## TPP

Use the [Central Directory Operation Guide](https://openfinancebrasil.atlassian.net/wiki/spaces/OF/pages/17378602/Guia+de+Opera+o+do+Diret+rio+Central) to register a new TPP (Software Statement).

Important information:

- It is not possible to change the Software Statement information after viewing the Software Statement Assertion.
- Check all fields **multiple times** before completing the registration.
- Pay special attention to the **`REDIRECT URI`** addresses.

### redirect_uri for Testing and Certification

The following URLs are suggested as redirect_uri when creating a Software Statement in the participant directory:

For Opus Open Banking testing tools:

- `https://tpp-client1.127.0.0.1.nip.io/cb`
- `https://tpp-client1.127.0.0.1.nip.io:3100/auth`
- `https://tpp-client1.127.0.0.1.nip.io:3100/cb`
- `https://tpp-client2.127.0.0.1.nip.io:3100/auth`
- `https://tpp-client2.127.0.0.1.nip.io:3100/cb`
- `https://tpp-client3.127.0.0.1.nip.io:3100/auth`
- `https://tpp-client3.127.0.0.1.nip.io:3100/cb`
- `https://tpp.127.0.0.1.nip.io:3100/auth`
- `https://tpp.127.0.0.1.nip.io:3100/cb`
- `https://tpp.localhost:3100/auth`
- `https://tpp.localhost:3100/cb`

For the OpenID certification tool (<https://gitlab.com/openid/conformance-suite>) or the functional certification tool (<https://gitlab.com/obb1/certification>) running locally:

- `https://www.certification.127.0.0.1.nip.io:8443/test/a/<alias>/callback`
- `https://www.certification.127.0.0.1.nip.io:8443/test/a/<alias>/callback?dummy1=lorem&dummy2=ipsum`

For the OpenID certification tool (<https://www.certification.openid.net/>):

- `https://www.certification.openid.net/test/a/<alias>/callback`
- `https://www.certification.openid.net/test/a/<alias>/callback?dummy1=lorem&dummy2=ipsum`

For the functional certification tool (<http://web.conformance.directory.openbankingbrasil.org.br/>):

- `https://web.conformance.directory.openbankingbrasil.org.br/test/a/<alias>/callback`

**Important**: The certification URLs must have the `<alias>` replaced with a string that uniquely identifies the installation to be certified, according to the [certification guide](https://openid.net/certification/connect_op_testing/#:~:text=You%20must%20select%20an%20%E2%80%9CALIAS%E2%80%9D%20to%20use) from OpenID. This prevents institutions' executions from interfering with each other.

### TPP Certificates

Client applications (TPPs) need 2 distinct certificates:

- BRCAC (JWK: `"use": "enc"`)
- BRSEAL (JWK: `"use": "sig"`)

The BRCAC certificate is used in MTLS connections for client application identification and encryption between the application and the bank.

The BRSEAL is used for signatures between the TPP application and the authentication server and also for signing JWS tokens.

### Converting Certificates to JWKS

After generating the BRCAC and BRSEAL certificates, it may be necessary to convert them into a JWKS to use in the OpenID certification program.

## Important Information for Certification Clients

The [OpenID certification program](https://gitlab.com/openid/conformance-suite) requires the following configurations (running locally):

### REDIRECT URI

<https://localhost:8443/test/a/obbsb/callback>

## Convert the Certificate to JWK

**IMPORTANT**: Never use online services to convert certificates. You do not want to put your most precious asset on an unknown site.

### Prerequisites

- Node
- `npm install -g pem-jwk`

### Steps

1. `openssl rsa -in <certificate>.key -out <certificate-in-rsa>.key`
2. `pem-jwk <certificate-in-rsa.key> > <jwk.json>`
3. Add the missing attributes:
   - `"use": "<enc|sig>"` (depends on the type of certificate: BRCAC=enc, BRSEAL=sig)
   - `"alg": "PS256"`
   - `"kid": "<kid>"`

    The value of the kid attribute can be obtained from the JWKS published in the central directory, which is the same as the PEM file generated by the central directory.

### Encapsulating in a JWKS

The structure of a JWKS file is as follows. Just add each JWK in the jwks attribute of the JSON.

```JSON
{ 
    "jwks": [ {
        <JWK-1>
    }, {
        <JWK-2>
    }]
}
```

## Useful Links

### Verifying Client Certificate Content

Just make a call using the desired certificate as the client certificate to the URL <https://prod.idrix.eu/secure/> and see the properties of your certificate.

### Generating JWKS Keys for Testing

The service <https://mkjwk.org/> generates JWKs in various possible formats, useful for **non-production** environments.
